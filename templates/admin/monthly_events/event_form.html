{% extends 'admin/base_admin.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h2>{% if event %}Edit{% else %}Create{% endif %} Monthly Event</h2>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label for="id_event_type" class="form-label">Event Type</label>
          {{ form.event_type }}
        </div>

        {% for field in form %}
          {% if field.name != 'event_type' and field.name != 'description' %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {{ field.errors|join:", " }}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- Description field with mini editor and char counter -->
        <div class="mb-3">
          <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
          <div class="mb-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTag('p')">Paragraph</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTag('br')">Break</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTag('b')">Bold</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTag('i')">Italic</button>
          </div>
          {{ form.description }}
          <div class="form-text">
            <span id="charCount">0</span>/1000 characters
          </div>
          {% if form.description.errors %}
            <div class="invalid-feedback d-block">
              {{ form.description.errors|join:", " }}
            </div>
          {% endif %}
        </div>

        <button type="submit" class="btn btn-primary">
          {% if event %}Update{% else %}Create{% endif %} Event
        </button>
        <a href="{% url 'monthly_events_list' %}" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
  function updateCharCount(textarea) {
    var max = 1000;
    var len = textarea.value.length;
    if (len > max) {
      textarea.value = textarea.value.substring(0, max);
      len = max;
    }
    document.getElementById("charCount").textContent = len;
  }

  function insertTag(tag) {
    var textarea = document.getElementById("id_description");
    var start = textarea.selectionStart;
    var end = textarea.selectionEnd;
    var value = textarea.value;
    var openTag = "<" + tag + ">";
    var closeTag = tag === "br" ? "" : "</" + tag + ">";
    var newValue = value.substring(0, start) + openTag + value.substring(start, end) + closeTag + value.substring(end);
    textarea.value = newValue;
    updateCharCount(textarea);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + openTag.length + (end - start) + closeTag.length;
  }

  document.addEventListener("DOMContentLoaded", function () {
    var textarea = document.getElementById("id_description");
    if (textarea) {
      updateCharCount(textarea);
      textarea.addEventListener("input", function () {
        updateCharCount(this);
      });
    }
  });
</script>
{% endblock %}
